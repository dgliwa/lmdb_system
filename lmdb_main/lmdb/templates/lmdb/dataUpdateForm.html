{% extends "base.html" %}
{% block pageName %}Data Update{% endblock %}
{% block customjs %}
    {% load static %}
    <script type="text/javascript" src="{% static "datepicker/jquery.simple-dtpicker.js" %}"></script>
	<link type="text/css" href="{% static "datepicker/jquery.simple-dtpicker.css" %}" rel="stylesheet" />
    <link rel="stylesheet" href="//js.arcgis.com/3.6/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="//js.arcgis.com/3.6/js/esri/css/esri.css">
    <script src="//js.arcgis.com/3.6/"></script>

    <script>
        $(document).ready(function() {
        

            $('.changelocation').click(function(e){
                a = $(this).parent();
                changeLocation(a);
            
            });
            $('.measurementForm').submit(function(e){
            e.preventDefault();
            var values = $(this).serialize();
            var objectid = $(this)[0][1].value;
            
            var a = $.post('/data/update/form/measurement/'+ objectid + '/', values, function(response) {
                // log the response to the console
                console.log("Response: "+response);
                if(response==="success"){
                    alert("Measurement Successfully Updated!");
                
                }
                else{
                    alert("Error Updating Measurement!");
                }
                
             });
                console.log(a);
            return false;
                });
                    
            
             $('.collectionForm').submit(function(e){
            e.preventDefault();
            var values = $(this).serialize();
            var objectid = $(this)[0][1].value;
            
            var a = $.post('/data/update/form/collection/'+ objectid + '/', values, function(response) {
                // log the response to the console
                console.log("Response: "+response);
                if(response==="success"){
                    alert("Collection Successfully Updated!");
                
                }
                else{
                    alert("Error Updating Collection!");
                }
             });
                console.log(a);
            return false;            
            });
            
             $('.changeForm').submit(function(e){
            e.preventDefault();
            var values = $(this).serialize();
            var objectid = $(this)[0][1].value;
            
            var a = $.post('/data/update/form/change/'+ objectid + '/', values, function(response) {
                // log the response to the console
                console.log("Response: "+response);
                if(response==="success"){
                    alert("Change Successfully Updated!");
                
                }
                else{
                    alert("Error Updating Change!");
                }
             });
                console.log(a);
            return false;
            });
            
             $('.sightingForm').submit(function(e){
            e.preventDefault();
            var values = $(this).serialize();
            var objectid = $(this)[0][1].value;
            
            var a = $.post('/data/update/form/sighting/'+ objectid + '/', values, function(response) {
                // log the response to the console
                console.log("Response: "+response);
                if(response==="success"){
                    alert("Sighting Successfully Updated!");
                
                }
                else{
                    alert("Error Updating Sighting!");
                }
             });
                console.log(a);
            return false;            
            });
            
            $(".paramForm").submit(function(e){
            e.preventDefault();
            var values = $(this).serialize();
            
            var name = $(this).attr('name')
      
            var a = $.post('/reference/parameters/createFromData/', values, function(response) {
    // log the response to the console
    console.log("Response: "+response);
    console.log(response['commonname']);
        $('.paramfield').append('<option value="' + response['id'] + '">' + response['commonname'] + '</option>');
      $('#'+name+' > .paramfield option:last').attr('selected','selected');
       },'json');
    console.log(a);
    this.reset();
        $(this).css('visibility','hidden')

    });

        $(".paramButton").click(function(e){
            $(this).closest("tr").find(".paramForm").css('visibility','visible');        
        });
        
        $(".organismButton").click(function(e){
            $(this).closest("tr").find(".organismForm").find(".kingdom").val($(this).parent().find(".kingdom").val());
            $(this).closest("tr").find(".organismForm").find(".phylum").val($(this).parent().find(".phylum").val());
            $(this).closest("tr").find(".organismForm").find(".class_field").val($(this).parent().find(".class_field").val());
            $(this).closest("tr").find(".organismForm").find(".order_field").val($(this).parent().find(".order_field").val());
            $(this).closest("tr").find(".organismForm").find(".family").val($(this).parent().find(".family").val());
            $(this).closest("tr").find(".organismForm").find(".genus").val($(this).parent().find(".genus").val());
            $(this).closest("tr").find(".organismForm").css('visibility','visible');        
        });
        
        $(".organismForm").submit(function(e){
            e.preventDefault();
            var values = $(this).serialize();
            var name = $(this).attr('name')
            var a = $.post('/reference/organisms/createFromData/', values, function(response) {
    // log the response to the console
    //console.log("Response: "+response);
    //console.log(response['commonname']);
 $(".organismfield").append('<option value="' + response['id'] + '">' + response['organismname'] + '</option>');
      $('#'+name+' > .organismfield option:last').attr('selected', 'selected');
       },'json');
    console.log(a);
    this.reset();
    $(this).css('visibility','hidden')

    });
        
                       
        });
        
        
//Organism AJAX functions

    $(function(){
    $("select.kingdom").change(function(){
      var name = $(this).parent().attr('id');
      $.getJSON("/reference/organisms/kingdomFilter/"+$(this).val()+"/", function(j) {
        var options = '<option value="">---------- </option>';
        for (var i = 0; i < j.length; i++) {
          options += '<option value="' + j[i].phylum + '">' + j[i].phylum + '</option>';
        }
        $("#"+name+" > .phylum").html(options);
        $("#"+name+" > .phylum").attr('selected', 'selected');
        $("#"+name+" > .phylum").attr('disabled', false);
      })
      $(this).attr('selected', 'selected');
      $.getJSON( "/reference/organisms/kingdom/"+$(this).val()+"/", function( data ) {
        var options = '<option value="">---------- </option>';
        for (var i = 0; i < data.length; i++) {
          options += '<option value="' + data[i].objectid + '">' + data[i].organismname + '</option>';
        }
        $("#"+name+" > .organismfield").html(options);
        $("#"+name+" > .organismfield option:first").attr('selected', 'selected');
});

    })
  })
  
  
$(function(){
    $("select.phylum").change(function(){
      var name = $(this).parent().attr('id');
      console.log(name);
      $.getJSON("/reference/organisms/phylumFilter/"+$(this).val()+"/", function(j) {
        console.log(j);
        var options = '<option value="">---------- </option>';
        for (var i = 0; i < j.length; i++) {
          options += '<option value="' + j[i].class_field + '">' + j[i].class_field + '</option>';
        }
        $("#"+name + " >.class_field").html(options);
        $("#"+name + " >.class_field option:first").attr('selected', 'selected');
        $("#"+name + " >.class_field").attr('disabled', false);
      })
      $(this).attr('selected', 'selected');
    $.getJSON( "/reference/organisms/phylum/"+$(this).val()+"/", function( data ) {
        var options = '<option value="">---------- </option>';
        for (var i = 0; i < data.length; i++) {
          options += '<option value="' + data[i].objectid + '">' + data[i].organismname + '</option>';
        }
        $("#"+name+" > .organismfield").html(options);
        $("#"+name+" > .organismfield option:first").attr('selected', 'selected');
});
    })
  })
  
$(function(){
    $("select.class_field").change(function(){
      var name = $(this).parent().attr('id'); 
      $.getJSON("/reference/organisms/classFilter/"+$(this).val()+"/", function(j) {
        var options = '<option value="">---------- </option>';
        for (var i = 0; i < j.length; i++) {
          options += '<option value="' + j[i].order_field + '">' + j[i].order_field + '</option>';
        }
        $("#" + name + "> .order_field").html(options);
        $("#" + name + "> .order_field option:first").attr('selected', 'selected');
        $("#" + name + "> .order_field").attr('disabled', false);
      })
      $(this).attr('selected', 'selected');
      $.getJSON( "/reference/organisms/class_field/"+$(this).val()+"/", function( data ) {
        var options = '<option value="">---------- </option>';
        for (var i = 0; i < data.length; i++) {
          options += '<option value="' + data[i].objectid + '">' + data[i].organismname + '</option>';
        }
       $("#"+name+" > .organismfield").html(options);
       $("#"+name+" > .organismfield option:first").attr('selected', 'selected');
});
    })
  })
  
$(function(){
    $("select.order_field").change(function(){
      var name = $(this).parent().attr('id');
      $.getJSON("/reference/organisms/orderFilter/"+$(this).val()+"/", function(j) {
        var options = '<option value="">---------- </option>';
        for (var i = 0; i < j.length; i++) {
          options += '<option value="' + j[i].family + '">' + j[i].family + '</option>';
        }
        $("#" + name + " > .family").html(options);
        $("#" + name +" > .family option:first").attr('selected', 'selected');
        $("#" + name +" > .family").attr('disabled', false);
      })
      $(this).attr('selected', 'selected');
      $.getJSON( "/reference/organisms/order_field/"+$(this).val()+"/", function( data ) {
        var options = '<option value="">---------- </option>';
        for (var i = 0; i < data.length; i++) {
          options += '<option value="' + data[i].objectid + '">' + data[i].organismname + '</option>';
        }
        $("#"+name+" > .organismfield").html(options);
        $("#"+name+" > .organismfield option:first").attr('selected', 'selected');
});
    })
  })
  
$(function(){
    $("select.family").change(function(){
      var name = $(this).parent().attr('id');
      $.getJSON("/reference/organisms/familyFilter/"+$(this).val()+"/", function(j) {
        var options = '<option value="">---------- </option>';
        for (var i = 0; i < j.length; i++) {
          options += '<option value="' + j[i].genus + '">' + j[i].genus + '</option>';
        }
        $("#" + name + " > .genus").html(options);
        $("#" + name + " > .genus option:first").attr('selected', 'selected');
        $("#" + name + " > .genus").attr('disabled', false);
      })
      $(this).attr('selected', 'selected');
      $.getJSON( "/reference/organisms/family/"+$(this).val()+"/", function( data ) {
        var options = '<option value="">---------- </option>';
        for (var i = 0; i < data.length; i++) {
          options += '<option value="' + data[i].objectid + '">' + data[i].organismname + '</option>';
        }
       $("#"+name+" > .organismfield").html(options);
       $("#"+name+" > .organismfield option:first").attr('selected', 'selected');
});
    })
  })

$(function(){
    $("select.genus").change(function(){
      var name = $(this).parent().attr('id');
      $.getJSON("/reference/organisms/genusFilter/"+$(this).val()+"/", function(j) {
        var options = '';
        console.log(j);
        for (var i = 0; i < j.length; i++) {
          options += '<option value="' + j[i].objectid + '">' + j[i].organismname + '</option>';
        }
       $("#"+name+" > .organismfield").html(options);
       $("#"+name+" > .organismfield option:first").attr('selected', 'selected');
      })
      $(this).attr('selected', 'selected');
    })
  })
        
      
        
        
        
//   
        
        function changeLocation(a){
            console.log(a);
            $(".dim").css('visibility','visible');
            $("#map_container.container").css('display','block');
            $(".dialog_wrapper").css('visibility','visible');
            $(".dialog").css('visibility','visible');
            $(".layerTile").css('visibility','visible');

            document.getElementById('newlocation').value = a[0].id
        }
        
        function verify(a){
        var b = document.getElementById('newlocation')
        
        var c = document.getElementById(document.getElementById('newlocation').value)
        if(c.className==='measurementForm'){
                c[13].value = a

        }
        else if(c.className==='changeForm'){
                c[15].value = a
        }
        else if(c.className==='collectionForm'){
                c[16].value = a
        }
        else if(c.className==='sightingForm'){
                c[15].value = a

        }
        
        $(".dim").css('visibility','hidden');
        $(".dialog_wrapper").css('visibility','hidden');
        $(".dialog").css('visibility','hidden');
        $(".layerTile").css('visibility','hidden');

        map.infoWindow.hide();

        }
        
        function closeWindow(){
        $(".dim").css('visibility','hidden');
        $(".dialog_wrapper").css('visibility','hidden');
        $(".dialog").css('visibility','hidden');
        $(".layerTile").css('visibility','hidden');

        map.infoWindow.hide();
        }
        
        
    </script> 


         
    </script>
    <style>
    .dim{
            height:100%;
            width:100%;
            position:fixed;
            left:0;
            top:10px;
            z-index:1 !important;
            background-color:black;
            filter: alpha(opacity=75); /* internet explorer */
            -khtml-opacity: 0.75;      /* khtml, old safari */
            -moz-opacity: 0.75;       /* mozilla, netscape */
            opacity: 0.75;           /* fx, safari, opera */
    }


    .dialog_wrapper{ 
            width: 100%; 
            top: 10px; 
            left: 0px; 
            position: absolute; 
            z-index: 5; 
            display: block;  
            }

    .dialog { 
            width: 75%; 
            height: 75%; 
            margin: 0 auto; 
            padding: 40px; 
            background-color: #fff;
            border: 1px solid #ccc; 
            color: #333;
        }
    #map_container.container{
            display: none;
    }    
    </style>
    
<script>
    var featureLayer;
dojo.require("esri.map");
dojo.require("esri.layers.FeatureLayer");
dojo.require("esri.layers.FeatureEditResult");
dojo.require("esri.geometry.Geometry");
dojo.require("dijit.TooltipDialog");
dojo.require("dijit.layout.BorderContainer");
dojo.require("dijit.layout.ContentPane");
dojo.require("esri.dijit.editing.TemplatePicker-all");
dojo.require("esri.tasks.gp");

var map;
require([
    "esri/map",
    "esri/toolbars/draw",
    "esri/toolbars/edit",
    "esri/graphic",
    "esri/config",

    "esri/layers/FeatureLayer",
    "esri/geometry/Point",
    "esri/symbols/SimpleMarkerSymbol",
    "esri/symbols/SimpleLineSymbol",
    "esri/symbols/SimpleFillSymbol",
    "esri/layers/ArcGISDynamicMapServiceLayer",
    "esri/layers/ImageParameters",
    "esri/dijit/editing/TemplatePicker",

    "dojo/_base/array",
    "dojo/_base/event",
    "dojo/_base/lang",
    "dojo/parser",
    "dijit/registry",

    "dijit/layout/BorderContainer", "dijit/layout/ContentPane",
    "dijit/form/Button", "dojo/domReady!"
], function (
    Map, Draw, Edit, Graphic, esriConfig,
    FeatureLayer,Point,
    SimpleMarkerSymbol, SimpleLineSymbol, SimpleFillSymbol,
    ArcGISDynamicMapServiceLayer,
    ImageParameters,
    TemplatePicker,
    arrayUtils, event, lang, parser, registry
) {
   // parser.parse();

    // refer to "Using the Proxy Page" for more information:  https://developers.arcgis.com/en/javascript/jshelp/ags_proxy.html
    esriConfig.defaults.io.proxyUrl = "/proxy/";

    // This service is for development and testing purposes only. We recommend that you create your own geometry service for use within your applications. 
    esriConfig.defaults.geometryService = new esri.tasks.GeometryService("http://tasks.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer");

    map = new Map("map", {
        basemap: "satellite",
        logo: true,
        center: [-88.366193, 42.289993],
        zoom: 14
    });

    map.on("layers-add-result", initEditing);



    dojo.connect(map, "onLoad",signIn);

function signIn() {
        console.log('signing in')
      //dojo.byId("signInStatus").innerHTML = "Creating token...";

      // Get token from the ArcGIS Server Token Service.
      //
      esri.request({
        url: "https://147.126.65.155:6443/arcgis/tokens/",
        content: {
          request: "getToken",
          username: "lmdb_user",
          password: "lmdb",
          // clientid may not be necessary; try commented out first, but this is the correct syntax.
          //clientid: "ref.https://lmdb.luc.edu/"  
        },
        handleAs: "text",
        load: tokenObtained,
        error: tokenRequestFailed
      });
    }

    function tokenObtained(response) {
      //dojo.byId("signInStatus").innerHTML = "Token created. Accessing the service...";

      // Add the secure feature service to the map
      // Note that the token is appended to the URL
      // when constructing the layer.
      console.log('token acquired')
     if({{points}}.length != 0){
         var pointFeatureLayerURL = "https://147.126.65.155:6443/arcgis/rest/services/campus/lurec_lmdb/FeatureServer/0?token=" + response;

     var queryString = ""
     for( var i=0;  i<{{points}}.length; i++){
         if (queryString == ""){
             queryString += "objectid =" + {{points}}[i];
         }
         else{
             queryString += " OR objectid =" + {{points}}[i];
         }
    
     }


    pointLayer = new FeatureLayer(pointFeatureLayerURL ,{
        mode: FeatureLayer.MODE_SNAPSHOT,
        outFields:["*"]
     });
         pointLayer.setDefinitionExpression(queryString);


    if ({{lines}}.length != 0){
        var lineFeatureLayerURL = "https://147.126.65.155:6443/arcgis/rest/services/campus/lurec_lmdb/FeatureServer/1?token=" + response;

    lineLayer = new FeatureLayer(lineFeatureLayerURL, {
        mode: FeatureLayer.MODE_SNAPSHOT,
        outFields: ["*"]
    });
    var queryString = ""
    for( var i=0; i<{{lines}}.length;i++){
        if (queryString == ""){
            queryString += "objectid =" + {{lines}}[i];
        }
        else{
            queryString += " OR objectid =" + {{lines}}[i];
        }
    
    }
    lineLayer.setDefinitionExpression(queryString);    }
    if({{polys}}.length!=0){
        var polyFeatureLayerURL = "https://147.126.65.155:6443/arcgis/rest/services/campus/lurec_lmdb/FeatureServer/2?token=" + response;

    polyLayer = new FeatureLayer(polyFeatureLayerURL, {
        mode: FeatureLayer.MODE_SNAPSHOT,
        outFields: ["*"]
    });
   var queryString = ""
    for( var i=0; i<{{polys}}.length; i++){
        if (queryString == ""){
            queryString += "objectid =" + {{polys}}[i];
        }
        else{
            queryString += " OR objectid =" + {{polys}}[i];
        }
    
    }
    polyLayer.setDefinitionExpression(queryString);}


       infoTemplate = new esri.InfoTemplate("Object ID : ${objectid}",
         "<input class=\"hidden\" id = \"locId\" value=\"${objectid}\"/>" +
         "You have selected to use this location.");


    if (pointLayer != null){
        pointLayer.setInfoTemplate(infoTemplate);
     }
     if (lineLayer != null){
         lineLayer.setInfoTemplate(infoTemplate);
     }
     if (polyLayer != null){
         polyLayer.setInfoTemplate(infoTemplate);
     }
var imageParameters = new ImageParameters();
        imageParameters.format = "jpeg";

     var dynamicMapServiceLayer = new ArcGISDynamicMapServiceLayer("https://147.126.65.155:6443/arcgis/rest/services/campus/lurec_lmdb_base/MapServer/?token=" + response, {
          "opacity" : 0.5,
          "imageParameters" : imageParameters
        });

           if( pointLayer == null || lineLayer == null || polyLayer == null){
         if(pointLayer!=null && lineLayer !=null){
             map.addLayers([pointLayer,lineLayer,dynamicMapServiceLayer]);
         }
         else if(pointLayer!=null && polyLayer!=null){
             map.addLayers([pointLayer,polyLayer,dynamicMapServiceLayer]);
         }
         else if(lineLayer!=null && polyLayer!=null){
             map.addLayers([lineLayer,polyLayer,dynamicMapServiceLayer]);
         }
         else if(pointLayer==null && lineLayer == null){
             map.addLayers([polyLayer,dynamicMapServiceLayer]);
         }
         else if(lineLayer==null && polyLayer==null){
             map.addLayers([pointLayer,dynamicMapServiceLayer]);
         }
         else if(pointLayer==null && polyLayer==null){
             map.addLayers([lineLayer,dynamicMapServiceLayer]);
         }
    }
    else{
        map.addLayers([pointLayer,lineLayer,polyLayer,dynamicMapServiceLayer]);
    }
      
  }

  dojo.connect(pointLayer, "onEditsComplete",
        function (addResults) {
            if (addResults.length > 0) {
                alert("objectid is: " + addResults[0].objectId);

                try{
                jQuery.post('/reference/locations/create/popup/',{'csrfmiddlewaretoken' : '{{ csrf_token }}','indicator': 'yes', 'type': 'point', 'objectid' :addResults[0].objectId}, function() {
  alert( "success" );
}); 
                }
                catch(err){
                console.log(err);
                }


var graphic = pointLayer.graphics[pointLayer.graphics.length - 1];
                graphic.attributes["additionalinformation"] = graphic.attributes["objectid"];
                try{
                x = graphic.geometry.x;
                y = graphic.geometry.y;
                sr = map.spatialReference;
                p = new Point(x,y,sr)
                //pointLayer = pointLayer.clearSelection();
                map.infoWindow.show(p);
                
                map.infoWindow.setContent(graphic.getContent());
                }
                catch(err){
                console.log(err);
                }
            }


        });


    dojo.connect(lineLayer, "onEditsComplete",
        function (addResults) {
            if (addResults.length > 0) {
                alert("objectid is: " + addResults[0].objectId);


try{                jQuery.post('/reference/locations/create/popup/',{'csrfmiddlewaretoken' : '{{ csrf_token }}','indicator': 'yes', 'type': 'line', 'objectid' :addResults[0].objectId}, function() {
  alert( "success" );
}); 
                }
                catch(err){
                console.log(err);
                }




                 var graphic = lineLayer.graphics[lineLayer.graphics.length - 1];
             graphic.attributes["additionalinformation"] = graphic.attributes["objectid"];
                try{
                x = graphic.geometry.paths[0][0][0];
                y = graphic.geometry.paths[0][0][1];
                sr = map.spatialReference;
                p = new Point(x,y,sr)
                map.infoWindow.show(p);
                
                map.infoWindow.setContent(graphic.getContent());
                }
                catch(err){
                console.log(err);
                }
                        }


        });




    dojo.connect(polyLayer, "onEditsComplete",
        function (addResults) {
            if (addResults.length > 0) {
                alert("objectid is: " + addResults[0].objectId);

try{
               jQuery.post('/reference/locations/create/popup/',{'csrfmiddlewaretoken' : '{{ csrf_token }}','indicator': 'yes', 'type': 'poly', 'objectid' :addResults[0].objectId}, function() {
  alert( "success" );
}); 
                }
                catch(err){
                console.log(err);
                }




                var graphic = polyLayer.graphics[polyLayer.graphics.length - 1];
             graphic.attributes["additionalinformation"] = graphic.attributes["objectid"];
                try{
                x = graphic.geometry.rings[0][0][0];
                y = graphic.geometry.rings[0][0][1];
                sr = map.spatialReference;
                p = new Point(x,y,sr)
                map.infoWindow.show(p);
                
                map.infoWindow.setContent(graphic.getContent());
                }
                catch(err){
                console.log(err);
                }
            }


        });
}

// for testing only
function tokenRequestFailed(error) {
    console.log(error)
      dojo.byId("signInStatus").innerHTML = "Unable to create token. Please check your username/password";
    }








    dojo.connect(map, "onLayersAddResult", initEditing);

    

      

    function initEditing(evt) {
        console.log("initEditing", evt);
        // var map = this;
        var currentLayer = null;
        var layers = arrayUtils.map(evt.layers, function (result) {
            return result.layer;
        });
        console.log("layers", layers);

        var editToolbar = new Edit(map);
        editToolbar.on("deactivate", function (evt) {
            currentLayer.applyEdits(null, [evt.graphic], null);
        });

        arrayUtils.forEach(layers, function (layer) {
            var editingEnabled = false;
            layer.on("dbl-click", function (evt) {
                event.stop(evt);
                if (editingEnabled === false) {
                    editingEnabled = true;
                    editToolbar.activate(Edit.EDIT_VERTICES, evt.graphic);
                } else {
                    currentLayer = this;
                    editToolbar.deactivate();
                    editingEnabled = false;
                }
            });

            layer.on("click", function (evt) {
                event.stop(evt);
               
            });
        });

        var templatePicker = new TemplatePicker({
            featureLayers: layers,
            rows: 1,
            columns: 3,
            grouping: false,
            style: "height: auto; width: 500px; overflow: auto;"
        }, "templatePickerDiv");

        templatePicker.startup();

        var drawToolbar = new Draw(map);

        var selectedTemplate;
        templatePicker.on("selection-change", function () {
            if (templatePicker.getSelected()) {
                selectedTemplate = templatePicker.getSelected();
            }
            switch (selectedTemplate.featureLayer.geometryType) {
            case "esriGeometryPoint":
                drawToolbar.activate(Draw.POINT);
                break;
            case "esriGeometryPolyline":
                drawToolbar.activate(Draw.POLYLINE);
                break;
            case "esriGeometryPolygon":
                drawToolbar.activate(Draw.POLYGON);
                break;
            }
        });

        drawToolbar.on("draw-end", function (evt) {
            drawToolbar.deactivate();
            editToolbar.deactivate();
            var newAttributes = lang.mixin({}, selectedTemplate.template.prototype.attributes);
            var newGraphic = new Graphic(evt.geometry, null, newAttributes);
            selectedTemplate.featureLayer.applyEdits([newGraphic], null, null);

        });
    }
    

});


   
</script> 
{% endblock %}

{% block customclass %}
class ="claro"
{% endblock %}
{% block content %}

{% if measurementforms or changeforms or collectionforms or sightingforms %}
    <!-- The first DIV for creating an Overlay -->
<div style="visibility:hidden" class="dim" >
</div>  

<!-- The second div. Note, that the wrapper is only need to center the real dialog div -->
<div style="visibility:hidden" class="dialog_wrapper">
<input type="text" id="newlocation" type="hidden" value=""/>

<div class="dialog">
<button class="btn btn-lg btn-primary" type="button" onclick="closeWindow()">Close</button>
<div data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="gutters:true, design:'headline'" style="width:100%;height:100%;">
      <div data-dojo-type="dijit/layout/ContentPane"  id="header" data-dojo-props="region:'top'" style="overflow:auto">
            To add a location, click on the desired type of location (point, line, polygon) and then click where it is located on the map.
      A popup will appear stating that it has been successfully added.

      <p>Add your new site in one of two ways.</p>
        <ol>
          <li>Enter geographic coordinates in the form below, or</li>
          <li>Click on the Sample Site point to the right then click on the map to add a point. </li>
        </ol>
      </p>
    <div style="float:left">
        <form id="latlonform" name='registration'  onSubmit="return latlonValidation();">
            <label for="name">Name:</label>  
            <input type="text" name="name" size="12" /> <br>             
            <label for="description">Description:</label>  
            <input type="text" name="description" size="12" /> <br> 
            <label for="latitude">Latitude (y):</label>  
            <input type="double" name="latitude" size="12" /> <br> 
            <label for="longitude">Longitude (x):</label> 
            <input type="double" name="longitude" size="12" /> 
            <input type="submit" name="submit" value="Add Site"/>
        </form>
      </div>
        <div id="templatePickerDiv"></div>

           </div>
      <div id="map" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'" style="height:600px"></div>
      <div id="rightPane" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'right'">

          </div>
          </div>
      </div>
</div>
    {% if measurementforms %}
    <h3>Measurements</h3>
        {% for form in measurementforms %}
<table>
            <tbody>
            <tr>
            <td style="width:75%">
            <form id="measurementForm{{form.objectid.value}}" class="measurementForm" method="post">
            {% csrf_token %}
            {{form.non_field_errors}}
            {{form.objectid.errors}}
            {{form.objectid}}
            {{form.mname.errors}}
            Name:  {{form.mname}}<br>
            {{form.parameterid.errors}}
            Parameter:  {{form.parameterid}}  <button type="button" class="btn btn-lg btn-primary paramButton">Add Parameter</button>

            <br>
            {{form.projectid.errors}}
            Project:  {{form.projectid}} <br>
            {{form.mediuform.errors}}
            Medium:  {{form.medium}} <br>
            {{form.mmethod.errors}}
            Measurement Method:  {{form.mmethod}} <br>
            {{form.mquant.errors}}
            Measurement Quantity: {{form.mquant}} <br>
            {{form.munits.errors}}
            Measurement Units:  {{form.munits}} <br>
            {{form.date.errors}}
            Measurement Date:  {{form.date}} <br>
           
            {{form.notes.errors}}
            Measurement Notes:  {{form.notes}} <br>
            {{form.personid.errors}}
            Person:  {{form.personid}}<br>

            {{form.locationid.errors}}
            Location:  {{form.locationid}} <button type="button" class="btn btn-lg btn-primary changelocation">Change Location</button><br>
            <input type="submit" value="Submit"/>

            </form>
            </td>
            <td>
            <form style = "visibility:hidden;" id="paramMeasurement{{form.objectid.value}}" class="paramForm" name="measurementForm{{form.objectid.value}}" >
            {% csrf_token %}
            <p>If you do not know the CAS or EPA Number(s), you can search for them <a href="http://ofmpub.epa.gov/sor_internet/registry/substreg/searchandretrieve/substancesearch/search.do" target="_blank">here</a></p>

            Scientific Name:
            <input class="sciname" type = "text" name="sciname"/>
            Common Name:
            <input class="comname" type = "text" name ="commonname"/>
            CAS Number:
            <input class="casnum" type = "text" name ="casnumber"/>
            EPA Number:
            <input class="epanum" type = "text" name="epanumber"/>

            <input type="submit" value="Submit"/>
            </form>
            </td>
            </tr>
            </tbody>
            </table>
        <br>
        <p>-----------------------------------------------------------<p>
        {% endfor %}
        
        
    {% endif %}
    {% if changeforms %}
        <h3>Changes</h3>

        {% for form in changeforms %}
        
        <table>
        <tbody>
        <tr>
        <td style="width:75%">
        <form id= "changeForm{{form.objectid.value}}" class="changeForm" method="post">
        {% csrf_token %}
        {{form.non_field_errors}}
        {{form.objectid.errors}}
        {{form.objectid}}
        {{form.description.errors}}
        Description:  {{form.description}}<br>
        {{form.justification.errors}}
        Justification:  {{form.justification}} <br>
        {{form.parameterid.errors}}
        Parameter:  {{form.parameterid}}  <button  type="button" class="btn btn-lg btn-primary paramButton">Add Parameter</button><br>
        {{form.projectid.errors}}
        Project:  {{form.projectid}} <br>
        {{form.permanent.errors}}
        Permanent Change:  {{form.permanent}} <br>
        {{form.chemicalapplication.errors}}
        Chemical Application: {{form.chemicalapplication}} <br>
        {{form.chemicalused.errors}}
        Chemical Used:  {{form.chemicalused}} <br>
        {{form.chemicalquantity.errors}}
        Chemical Quantity:  {{form.chemicalquantity}} <br>
        {{form.chemicalunits.errors}}
        Chemical Units:  {{form.chemicalunits}} <br>
        {{form.areachange.errors}}
        Area of the Change:  {{form.areachange}}<br>
        {{form.date.errors}}
        Change Date:  {{form.date}} <br>
       
        {{form.personid.errors}}
        Person:  {{form.personid}}<br>

        {{form.locationid.errors}}
        Location:  {{form.locationid}} <button type="button" class="btn btn-lg btn-primary changelocation">Change Location</button><br> 
        <input type="submit" value="Submit"/>
        </form>
        </td>
        <td>
        <form style = "visibility:hidden;" id="paramChange{{form.objectid.value}}" class="paramForm" name="changeForm{{form.objectid.value}}" >
        {% csrf_token %}
        <p>If you do not know the CAS or EPA Number(s), you can search for them <a href="http://ofmpub.epa.gov/sor_internet/registry/substreg/searchandretrieve/substancesearch/search.do" target="_blank">here</a></p>

        Scientific Name:
        <input id="sciname" type = "text" name="sciname"/>
        Common Name:
        <input id="comname" type = "text" name ="commonname"/>
        CAS Number:
        <input id="casnum" type = "text" name ="casnumber"/>
        EPA Number:
        <input id="epanum" type = "text" name="epanumber"/>

        <input type="submit" value="Submit"/>
        </form>
        </td>
        </tr>
        </tbody>
        </table>
        <br>
        <p>-----------------------------------------------------------<p>
        {% endfor %}
    {% endif %}
    {% if collectionforms %}
        <h3>Collections</h3>
        {% for form in collectionforms %}
            <table>
            <tbody>
            <tr>
            <td style="width:75%">
            <form id = "collectionForm{{form.objectid.value}}" class="collectionForm"  method="post">
            {% csrf_token %}
            {{form.non_field_errors}}
            {{form.objectid.errors}}
            {{form.objectid}}

            Organism Kingdom:  <select id="id_kingdom" class="kingdom" name="kingdom">
            <option value="" selected="selected">---------- </option>
            <option value="Bacteria">Bacteria</option>
            <option value="Archaea">Archaea</option>
            <option value="Protista">Protista</option>
            <option value="Plantae">Plantae</option>
            <option value="Fungi">Fungi</option>
            <option value="Animalia">Animalia</option>
            </select><br>

            Organism Phylum: <select disabled="True" id="id_phylum" class="phylum" name="phylum">
            </select> <br>
 
            Organism Class:  <select disabled="True" id="id_class_field" class="class_field" name="class_field">
            </select><br>

            Organism Order:  <select disabled="True" id="id_order_field" class="order_field" name="order_field">
            </select><br>

            Organism Family:  <select disabled="True" id="id_family" class="family" name="family">
            </select><br>

            Organism Genus:  <select disabled="True" id="id_genus" class="genus" name="genus">
            </select><br>
            {{form.organismid.errors}}
            Organism:  {{form.organismid}}  <button type="button" class="btn btn-lg btn-primary organismButton">Add Organism</button><br> 
            {{form.projectid.errors}}
            Project:  {{form.projectid}} <br>
            {{form.methodcollect.errors}}
            Collection Method:  {{form.methodcollect}} <br>
            {{form.stored.errors}}
            Collection Stored: {{form.stored}} <br>
            {{form.storecollect.errors}}
            Collection Storer:  {{form.storecollect}} <br>
            {{form.datecollect.errors}}
            Collection Date:  {{form.datecollect}} <br>
            

            {{form.personid.errors}}
            Person:  {{form.personid}}<br>
            {{form.locationid.errors}}
            Location:  {{form.locationid}} <button type="button" class="btn btn-lg btn-primary changelocation">Change Location</button><br> 
            <input type="submit" value="Submit"/>

            </form>
            </td>
            <td>
            <div>
            <form style="visibility:hidden" id="organismCollection{{form.objectid.value}}" name="collectionForm{{form.objectid.value}}" class="organismForm">
            {% csrf_token %}

            Organism Kingdom:  <select class="kingdom" name="kingdom">
            <option value="" selected="selected">---------- </option>
            <option value="Bacteria">Bacteria</option>
            <option value="Archaea">Archaea</option>
            <option value="Protista">Protista</option>
            <option value="Plantae">Plantae</option>
            <option value="Fungi">Fungi</option>
            <option value="Animalia">Animalia</option>
            </select><br>

            Organism Phylum: <input type="text" class="phylum" name="phylum"/>
 
            Organism Class:  <input type="text" class="class_field" name="class_field"/>


            Organism Order:  <input type="text" class="order_field" name="order_field"/>

            Organism Family:  <input type="text" class="family" name="family"/>

            Organism Genus:  <input type="text" class="genus" name="genus"/>

            Organism Species <input type="text" class= "species" name="species"/>

            Organism Name:  <input type="text" class = "organismname" name="organismname"/>

            <input type="submit" value="Submit"/>
            </form>
            </div>
            </td>
            </tr>
            </tbody>
            </table>
            <br>
            <p>-----------------------------------------------------------<p>
        {% endfor %}
    {% endif %}
    {% if sightingforms %}
        <h3>Sightings</h3>
        {% for form in sightingforms %}
        <table>
        <tbody>
        <tr>
        <td style="width:75%">
        <form id = "sightingForm{{form.objectid.value}}" class="sightingForm"  method="post">


        {% csrf_token %}
        {{form.non_field_errors}}
        {{form.objectid.errors}}
        {{form.objectid}}
        Organism Kingdom:  <select id="id_kingdom" name="kingdom">
        <option value="" selected="selected">---------- </option>
        <option value="Bacteria">Bacteria</option>
        <option value="Archaea">Archaea</option>
        <option value="Protista">Protista</option>
        <option value="Plantae">Plantae</option>
        <option value="Fungi">Fungi</option>
        <option value="Animalia">Animalia</option>
        </select><br>

        Organism Phylum: <select disabled="True" id="id_phylum" name="phylum">
        </select> <br>
 
        Organism Class:  <select disabled="True" id="id_class_field" name="class_field">
        </select><br>

        Organism Order:  <select disabled="True" id="id_order_field" name="order_field">
        </select><br>

        Organism Family:  <select disabled="True" id="id_family" name="family">
        </select><br>

        Organism Genus:  <select disabled="True" id="id_genus" name="genus">
        </select><br>
        {{form.organismid.errors}}
        Organism:  {{form.organismid}}  <button type="button" class="btn btn-lg btn-primary organismButton">Add Organism</button><br> 
        {{form.projectid.errors}}
        Project:  {{form.projectid}} <br>

        {{form.number.errors}}
        Number:  {{form.number}} <br>
        Sighting Date:  {{form.date}} <br>
        

        {{form.notes.errors}}
        Sighting Notes:  {{form.notes}} <br>
        {{form.personid.errors}}
        Person:  {{form.personid}}<br>

        {{form.locationid.errors}}
        Location:  {{form.locationid}} <button type="button" class="btn btn-lg btn-primary changelocation">Change Location</button><br> 
        <input type="submit" value="Submit"/>

        </form>

        </td>
        <td>
        <div>
        <form style="visibility:hidden" id="organismSighting{{form.objectid.value}}" name="sightingForm{{form.objectid.value}}" class="organismForm">
        Organism Kingdom:  <select class="kingdom" name="kingdom">
        <option value="" selected="selected">---------- </option>
        <option value="Bacteria">Bacteria</option>
        <option value="Archaea">Archaea</option>
        <option value="Protista">Protista</option>
        <option value="Plantae">Plantae</option>
        <option value="Fungi">Fungi</option>
        <option value="Animalia">Animalia</option>
        </select><br>

        Organism Phylum: <input type="text" class="phylum" name="phylum"/>
 
        Organism Class:  <input type="text" class="class_field" name="class_field"/>


        Organism Order:  <input type="text" class="order_field" name="order_field"/>

        Organism Family:  <input type="text" class="family" name="family"/>

        Organism Genus:  <input type="text" class="genus" name="genus"/>

        Organism Species <input type="text" class = "species" name="species"/>

        Organism Name:  <input type="text" class = "organismname" name="organismname"/>

        <input type="submit" value="Submit"/>
        </form>
        </div>
        </td>
        </tr>
        </tbody>
        </table>
        {% endfor %}
    {% endif %}
{% else %}
<h3>None Selected</h3>
{% endif %}
<script type="text/javascript">
                    $(function(){
                        $('.datefield').appendDtpicker();
                    });
                </script>
{% endblock %}
