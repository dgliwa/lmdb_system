{% extends "mapbase.html" %}

{% block custom_map %}

    dojo.connect(pointLayer, "onEditsComplete",
        function (addResults) {
            if (addResults.length > 0) {
                alert("objectid is: " + addResults[0].objectId);


                method = "post"; // Set method to post by default, if not specified.

                // The rest of this code assumes you are not using a library.
                // It can be made less wordy if you use one.
                var form = document.createElement("form");
                form.setAttribute("method", method);
                form.setAttribute("action", '/reference/locations/create/popup/');
                form.setAttribute("target", '_blank');

                var csrfToken = document.createElement("input");
                csrfToken.setAttribute("type", "hidden");
                csrfToken.setAttribute("name", "csrfmiddlewaretoken");
                csrfToken.setAttribute("value", "{{ csrf_token }}");
                form.appendChild(csrfToken);


                var indicator = document.createElement("input");
                indicator.setAttribute("type", "hidden");
                indicator.setAttribute("name", "indicator");
                indicator.setAttribute("value", "yes");
                form.appendChild(indicator);


                var type = document.createElement("input");
                type.setAttribute("type", "hidden");
                type.setAttribute("name", "type");
                type.setAttribute("value", "point");
                form.appendChild(type);

                var hiddenField = document.createElement("input");
                hiddenField.setAttribute("type", "hidden");
                hiddenField.setAttribute("name", 'objectid');
                hiddenField.setAttribute("value", addResults[0].objectId);

                form.appendChild(hiddenField);



                document.body.appendChild(form);
                form.submit();



                document.getElementById('id_locationid').value=addResults[0].objectId;

                var graphic = pointLayer.graphics[pointLayer.graphics.length - 1];
                graphic.attributes["additionalinformation"] = graphic.attributes["objectid"];
                try{
                x = graphic.geometry.x;
                y = graphic.geometry.y;
                sr = map.spatialReference;
                p = new Point(x,y,sr)
                map.infoWindow.show(p);
                
                map.infoWindow.setContent(graphic.getContent());
                }
                catch(err){
                console.log(err);
                }

            }


        });

        dojo.connect(lineLayer, "onEditsComplete",
        function (addResults) {
            if (addResults.length > 0) {
                alert("objectid is: " + addResults[0].objectId);


                method = "post"; // Set method to post by default, if not specified.

                // The rest of this code assumes you are not using a library.
                // It can be made less wordy if you use one.
                var form = document.createElement("form");
                form.setAttribute("method", method);
                form.setAttribute("action", '/reference/locations/create/popup/');
                form.setAttribute("target", '_blank');


                var csrfToken = document.createElement("input");
                csrfToken.setAttribute("type", "hidden");
                csrfToken.setAttribute("name", "csrfmiddlewaretoken");
                csrfToken.setAttribute("value", "{{ csrf_token }}");
                form.appendChild(csrfToken);


                var indicator = document.createElement("input");
                indicator.setAttribute("type", "hidden");
                indicator.setAttribute("name", "indicator");
                indicator.setAttribute("value", "yes");
                form.appendChild(indicator);


                var type = document.createElement("input");
                type.setAttribute("type", "hidden");
                type.setAttribute("name", "type");
                type.setAttribute("value", "line");
                form.appendChild(type);


                var hiddenField = document.createElement("input");
                hiddenField.setAttribute("type", "hidden");
                hiddenField.setAttribute("name", 'objectid');
                hiddenField.setAttribute("value", addResults[0].objectId);

                form.appendChild(hiddenField);



                document.body.appendChild(form);
                form.submit();



                document.getElementById('id_locationid').value=addResults[0].objectId;

             var graphic = lineLayer.graphics[lineLayer.graphics.length - 1];
             graphic.attributes["additionalinformation"] = graphic.attributes["objectid"];
                try{
                x = graphic.geometry.paths[0][0][0];
                y = graphic.geometry.paths[0][0][1];
                sr = map.spatialReference;
                p = new Point(x,y,sr)
                map.infoWindow.show(p);
                
                map.infoWindow.setContent(graphic.getContent());
                }
                catch(err){
                console.log(err);
                }
            
            
            
            }


        });




    dojo.connect(polyLayer, "onEditsComplete",
        function (addResults) {
            if (addResults.length > 0) {
                alert("objectid is: " + addResults[0].objectId);


                method = "post"; // Set method to post by default, if not specified.

                // The rest of this code assumes you are not using a library.
                // It can be made less wordy if you use one.
                var form = document.createElement("form");
                form.setAttribute("method", method);
                form.setAttribute("action", '/reference/locations/create/popup/');
                form.setAttribute("target", '_blank');

                var csrfToken = document.createElement("input");
                csrfToken.setAttribute("type", "hidden");
                csrfToken.setAttribute("name", "csrfmiddlewaretoken");
                csrfToken.setAttribute("value", "{{ csrf_token }}");
                form.appendChild(csrfToken);


                var indicator = document.createElement("input");
                indicator.setAttribute("type", "hidden");
                indicator.setAttribute("name", "indicator");
                indicator.setAttribute("value", "yes");
                form.appendChild(indicator);


                var type = document.createElement("input");
                type.setAttribute("type", "hidden");
                type.setAttribute("name", "type");
                type.setAttribute("value", "poly");
                form.appendChild(type);


                var hiddenField = document.createElement("input");
                hiddenField.setAttribute("type", "hidden");
                hiddenField.setAttribute("name", 'objectid');
                hiddenField.setAttribute("value", addResults[0].objectId);

                form.appendChild(hiddenField);



                document.body.appendChild(form);
                form.submit();



                document.getElementById('id_locationid').value=addResults[0].objectId;

                 var graphic = polyLayer.graphics[polyLayer.graphics.length - 1];
             graphic.attributes["additionalinformation"] = graphic.attributes["objectid"];
                try{
                x = graphic.geometry.rings[0][0][0];
                y = graphic.geometry.rings[0][0][1];
                sr = map.spatialReference;
                p = new Point(x,y,sr)
                map.infoWindow.show(p);
                
                map.infoWindow.setContent(graphic.getContent());
                }
                catch(err){
                console.log(err);
                }
           

            }


        });
      
  }




    // map.addLayers([pointLayer,lineLayer,polyLayer]);




    function initEditing(evt) {
        console.log("initEditing", evt);
        // var map = this;
        var currentLayer = null;
        var layers = arrayUtils.map(evt.layers, function (result) {
            return result.layer;
        });
        console.log("layers", layers);

        var editToolbar = new Edit(map);
        editToolbar.on("deactivate", function (evt) {
            currentLayer.applyEdits(null, [evt.graphic], null);
        });

        arrayUtils.forEach(layers, function (layer) {
            var editingEnabled = false;
            layer.on("dbl-click", function (evt) {
                event.stop(evt);
                if (editingEnabled === false) {
                    editingEnabled = true;
                    editToolbar.activate(Edit.EDIT_VERTICES, evt.graphic);
                } else {
                    currentLayer = this;
                    editToolbar.deactivate();
                    editingEnabled = false;
                }
            });

            layer.on("click", function (evt) {
                event.stop(evt);
                document.getElementById('id_locationid').value=document.getElementById('locId').value;
               
            });
        });

        var templatePicker = new TemplatePicker({
            featureLayers: layers,
            rows: 1,
            columns: 3,
            grouping: false,
            style: "height: auto; width: 500px; overflow: auto;"
        }, "templatePickerDiv");

        templatePicker.startup();

        var drawToolbar = new Draw(map);

        var selectedTemplate;
        templatePicker.on("selection-change", function () {
            if (templatePicker.getSelected()) {
                selectedTemplate = templatePicker.getSelected();
            }
            switch (selectedTemplate.featureLayer.geometryType) {
            case "esriGeometryPoint":
                drawToolbar.activate(Draw.POINT);
                break;
            case "esriGeometryPolyline":
                drawToolbar.activate(Draw.POLYLINE);
                break;
            case "esriGeometryPolygon":
                drawToolbar.activate(Draw.POLYGON);
                break;
            }
        });

        drawToolbar.on("draw-end", function (evt) {
            drawToolbar.deactivate();
            editToolbar.deactivate();
            var newAttributes = lang.mixin({}, selectedTemplate.template.prototype.attributes);
            var newGraphic = new Graphic(evt.geometry, null, newAttributes);
            selectedTemplate.featureLayer.applyEdits([newGraphic], null, null);

        });
    }
    

});

function geocode(lonNum, latNum, name, desc) {
    point = new esri.geometry.geographicToWebMercator(esri.geometry.Point(lonNum, latNum, new esri.SpatialReference({
        wkid: 4326
    })));
    var myGraphic = new esri.Graphic(point);
    myGraphic.setAttributes({
        'description': desc
    })
    try {
        lmdbPointLayer.applyEdits([myGraphic], null, null);
    } catch (err) {
        console.log(err);
    }
    addGraphic(point);
    alert('New point location successfully created!');
}

function addGraphic(geometry) {
    map.graphics.clear();
    var symbol = new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_SQUARE, 10);
    map.graphics.add(new esri.Graphic(geometry, symbol));
}


function latlonValidation() {
    var lat = document.forms["registration"]["latitude"].value;
    var latNum = Number(lat);
    var lon = document.forms["registration"]["longitude"].value;
    var lonNum = Number(lon);
    var name = document.forms["registration"]["name"].value;
    var desc = document.forms["registration"]["description"].value;



    var validLat = (lat.match(/^[-+]?(?:\d+\.?\d*|\.\d+)$/));
    var validLon = (lon.match(/^[-+]?(?:\d+\.?\d*|\.\d+)$/));

    if (!validLat) {
        alert("Please enter numeric characters only for Latitude. Integers or Decimals with +/- signs are accepted.");
        return false;
    }

    if (!validLon) {
        alert("Please enter numeric characters only for Longitude. Integers or Decimals with +/- signs are accepted.");
        return false;
    }

    if ((latNum <= -90) || (latNum >= 90)) {
        alert("Please enter a value for latitude between -90.0 and 90.0");
        return false;
    }
    if ((lonNum <= -180) || (lonNum >= 180)) {
        alert("Please enter a value for longitude between -180.0 and 180.0");
        return false;
    }
    geocode(lonNum, latNum, name, desc);
    return true;
}

{% endblock %}
